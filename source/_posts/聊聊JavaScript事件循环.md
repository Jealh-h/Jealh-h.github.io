---
title: èŠèŠJavaScriptäº‹ä»¶å¾ªç¯
date: 2022-01-12 23:37:00
tags:
categories: javascript
---

**äº‹æƒ…è¿˜å¾—ä»è¿™ä¹ˆä¸€é“é¢˜å¼€å§‹ï¼š**

```javascript
let p = new Promise((resolve, reject) => {
  console.log("p");
});
setTimeout(() => {
  console.log("setTime");
}, 0);
console.log("end");
```

å„ä½æƒ³æƒ³ä¸‹é¢çš„è¾“å‡ºé¡ºåºæ˜¯ä»€ä¹ˆå§ï¼Ÿ
æˆ‘å…ˆè¯´ä¸€ä¸‹æˆ‘çš„ç­”æ¡ˆå§ï¼š

> end
> p
> setTime

ä¸Šé¢çš„è¾“å‡ºæ˜¯é”™è¯¯çš„ ğŸ˜¥ï¼Œæˆ‘æ˜¯æ€ä¹ˆä¹Ÿä¸å¼€å¿ƒå•Šï¼Œäºæ˜¯æˆ‘å°±å¼€å§‹ç¿»éå„ç§èµ„æ–™ï¼Œå…¶ä¸­åŒ…æ‹¬ä»»åŠ¡ã€å¾®ä»»åŠ¡ã€JavaScript äº‹ä»¶å¾ªç¯ã€Promise ç­‰ç­‰èµ„æ–™ã€‚ä¸‹é¢å°±è®©æˆ‘æ¥ç»†è¯´å§ã€‚

<!-- more-->

**é¦–å…ˆä»‹ç»å‡ ä¸ªé‡è¦çš„æ¦‚å¿µã€‚**

## ç›¸å…³æ¦‚å¿µ

### ä»»åŠ¡ï¼ˆå®ä»»åŠ¡ï¼‰

ä»»åŠ¡æœ‰ä»¥ä¸‹ä¸‰ç±»ï¼š

- ä¸€æ®µæ–°ç¨‹åºæˆ–å­ç¨‹åºè¢«ç›´æ¥æ‰§è¡Œæ—¶ï¼ˆæ¯”å¦‚ä»ä¸€ä¸ªæ§åˆ¶å°ï¼Œæˆ–åœ¨ä¸€ä¸ª &lt;script&gt; å…ƒç´ ä¸­è¿è¡Œä»£ç ï¼‰ã€‚
- è§¦å‘äº†ä¸€ä¸ªäº‹ä»¶ï¼Œå°†å…¶**å›è°ƒå‡½æ•°**æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—æ—¶ã€‚
- æ‰§è¡Œåˆ°ä¸€ä¸ªç”± setTimeout() æˆ– setInterval() åˆ›å»ºçš„ timeout æˆ– intervalï¼Œä»¥è‡´ç›¸åº”çš„**å›è°ƒå‡½æ•°**è¢«æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—æ—¶ã€‚
- setImmediate()å›è°ƒï¼ˆnodejsï¼‰
- I/O
- UI
- postMessage

### å¾®ä»»åŠ¡

- promise.then(callback)ä¸­çš„**callback**ã€‚
- MutationObserver
- process.nextTick(Node.js)
- Object.observe

### æ‰§è¡Œæ ˆ

å‡½æ•°çš„äº’ç›¸è°ƒç”¨ä¼šè®©å‡½æ•°æ ‘å½¢æˆä¸€ä¸ªè°ƒç”¨æ ˆï¼Œè€Œå‡½æ•°çš„æ‰§è¡Œä¼šæŒ‰ç…§è¿™ä¸ªæ ˆæ¥æ‰§è¡Œï¼Œå³åè¿›å…ˆæ‰§è¡Œã€‚æ‰§è¡Œæ ˆä¼šå ç”¨ JavaScript çš„ run timeã€‚

### æ‰§è¡Œä¸Šä¸‹æ–‡

JavaScript åœ¨è¿è¡Œæ—¶ï¼Œæ˜¯è¿è¡Œåœ¨æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­çš„ï¼Œæ¯ä¸€ä¸ªä¸Šä¸‹æ–‡æ‹¥æœ‰è‡ªå·±çš„å˜é‡ã€å¯¹è±¡ï¼Œæ‰§è¡Œä¸Šä¸‹æ–‡æœ‰å¦‚ä¸‹å‡ ç±»ï¼š

- å…¨å±€ä¸Šä¸‹æ–‡ï¼šåœ¨ JavaScript å¼€å§‹æ‰§è¡Œæ—¶ä¾¿åˆ›å»ºï¼Œæ˜¯æœ€åŸºç¡€çš„ä¸Šä¸‹æ–‡ã€‚
- å‡½æ•°ä¸Šä¸‹æ–‡ï¼ˆå±€éƒ¨ä¸Šä¸‹æ–‡ï¼‰ï¼šåœ¨å‡½æ•°è°ƒç”¨æ—¶ä¼šåˆ›å»ºï¼Œä¸€ä¸ªå‡½æ•°çš„æ‰§è¡Œï¼Œä¼´éšä¸€ä¸ªå‡½æ•°ä¸Šä¸‹æ–‡çš„äº§ç”Ÿã€‚
- eval ä¸Šä¸‹æ–‡ï¼šä½¿ç”¨ eval å‡½æ•°æ‰€åˆ›å»ºçš„ä¸Šä¸‹æ–‡ã€‚

### JavaScript RunTime

æ‰§è¡Œ js ä»£ç æ—¶ï¼Œè¿è¡Œæ—¶å¼•æ“æ‹¥æœ‰ä¸€ç³»åˆ—çš„ä»£ç†ï¼Œæ¯ä¸€ä¸ªä»£ç†ç”±ä¸€ç³»åˆ—çš„æ‰§è¡Œä¸Šä¸‹æ–‡ã€æ‰§è¡Œæ ˆã€ä¸»çº¿ç¨‹ã€é™„åŠ çº¿ç¨‹ï¼ˆworkerï¼‰ã€ä»»åŠ¡é˜Ÿåˆ—ã€å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚å¸¸è§çš„ JavaScript run time æœ‰ iframeã€web workerã€JavaScript ä¸»çº¿ç¨‹ã€‚

### äº‹ä»¶å¾ªç¯

äº‹ä»¶å¾ªç¯è´Ÿè´£æ”¶é›†ç”¨äº‹ä»¶ï¼ˆåŒ…æ‹¬ç”¨æˆ·äº‹ä»¶ä»¥åŠå…¶ä»–éç”¨æˆ·äº‹ä»¶ç­‰ï¼‰ã€å¯¹ä»»åŠ¡è¿›è¡Œæ’é˜Ÿä»¥ä¾¿åœ¨åˆé€‚çš„æ—¶å€™æ‰§è¡Œå›è°ƒã€‚ç„¶åå®ƒæ‰§è¡Œæ‰€æœ‰å¤„äºç­‰å¾…ä¸­çš„ JavaScript ä»»åŠ¡ï¼ˆå®ä»»åŠ¡ï¼‰ï¼Œç„¶åæ˜¯å¾®ä»»åŠ¡ï¼Œç„¶ååœ¨å¼€å§‹ä¸‹ä¸€æ¬¡å¾ªç¯ä¹‹å‰æ‰§è¡Œä¸€äº›å¿…è¦çš„æ¸²æŸ“å’Œç»˜åˆ¶æ“ä½œã€‚æ¯ä¸€ä¸ª JavaScript run time éƒ½ä¼šæ‹¥æœ‰è‡ªå·±çš„äº‹ä»¶å¾ªç¯ï¼ŒRunTime é‡Œé¢çš„ä»£ç†ç”±äº‹ä»¶å¾ªç¯æ‰€é©±åŠ¨ã€‚
**äº‹ä»¶å¾ªç¯åˆ†ä¸ºä¸‰ç±»ï¼š**

#### window event loop

é©±åŠ¨åŒæºçš„çª—å£ï¼ˆFrame,Tabï¼‰çš„äº‹ä»¶å¾ªç¯ï¼Œæ¥è‡ªç›¸åŒ origin çš„ window å¯èƒ½å…±äº«åŒä¸€ä¸ªäº‹ä»¶å¾ªç¯

#### worker event loop

é©±åŠ¨ worker æ‰§è¡Œï¼ˆweb workersã€ shared workersã€service workersï¼‰worker æ‹¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªä¸ä¸»ç¨‹åºä¸åŒçš„ä»£ç†ã€‚

#### worklet event loop

é©±åŠ¨ worklet ä»£ç†çš„è¿è¡Œã€‚worklet çš„ç±»å‹åŒ…æ‹¬ï¼ˆWorkletã€AudioWorkletã€PaintWorkletï¼‰ã€‚

### Promise

ä¸€ç§å¼‚æ­¥ JavaScript çš„è§£å†³æ–¹æ¡ˆï¼Œæ˜¯å¯¹å¼‚æ­¥æ–¹æ³•çš„è¿”å›å€¼çš„ä¸€ç§æè¿°ï¼Œç”¨äºåœ¨å°†æ¥æŸä¸ªæ—¶åˆ»å°†å¼‚æ­¥ç»“æœè¿”å›ç»™ä½¿ç”¨è€…ï¼Œæœ€é‡è¦çš„ä¸€ç‚¹æ˜¯é€šè¿‡ then é“¾å¼è°ƒç”¨ã€‚

## äº‹ä»¶å¾ªç¯æœºåˆ¶

åœ¨æ¯ä¸€è½®äº‹ä»¶å¾ªç¯å¼€å§‹æ—¶ï¼ŒRunTime ä¼šä»ä»»åŠ¡é˜Ÿåˆ—é‡Œé¢å–å‡ºä»»åŠ¡æ¥æ‰§è¡Œï¼Œå¦‚æœä»»åŠ¡é‡Œé¢åˆæ·»åŠ äº†æ–°ä»»åŠ¡åˆ°é˜Ÿåˆ—é‡Œé¢ï¼Œæ–°ä»»åŠ¡ä¸ä¼šå†æœ¬è½®äº‹ä»¶å¾ªç¯é‡Œå»æ‰§è¡Œã€‚å½“ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œå¼¹å‡ºä»»åŠ¡é˜Ÿåˆ—æ—¶ï¼Œå¹¶ä¸”æ‰§è¡Œæ ˆä½ç©ºæ—¶ï¼Œè¿™æ—¶ä¼šå¼€å§‹æ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¾®ä»»åŠ¡ä¸ä¼šåƒä»»åŠ¡é‚£æ ·æ¯æ¬¡åªæ‰§è¡Œä¸€ä¸ªï¼Œè€Œæ˜¯å°†å¾®ä»»åŠ¡é˜Ÿåˆ—é‡Œçš„å¾®ä»»åŠ¡æ‰§è¡Œå®Œï¼Œå³ä½¿æ˜¯åœ¨æ‰§è¡Œå¾®ä»»åŠ¡æ—¶æœ‰æ–°çš„å¾®ä»»åŠ¡åŠ å…¥åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œåœ¨ä¸‹ä¸€ä¸ªä»»åŠ¡å¼€å§‹ä»¥åŠäº‹ä»¶å¾ªç¯è¿­ä»£ç»“æŸä¹‹å‰ä¾ç„¶ä¼šæ‰§è¡Œå¾®ä»»åŠ¡ã€‚
OKï¼Œè¯´åˆ°è¿™å„¿ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥åˆ†æä»¥ä¸‹åˆšæ‰çš„é¢˜äº†ã€‚

## é¢˜ç›®åˆ†æ

```javascript
let p = new Promise((resolve, reject) => {
  console.log("p");
});
setTimeout(() => {
  console.log("setTime");
}, 0);
console.log("end");
```

**æœ€å¼€å§‹ï¼š**å°†æ•´ä½“ä»£ç ï¼ˆä¸€æ®µæ–°ç¨‹åºï¼‰åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ã€‚æ­¤æ—¶çš„ JavaScript RunTime çš„æƒ…å†µå¦‚ä¸‹å›¾ï¼š
![1](https://gitee.com/gitme-H/images-bed/raw/master/img/202201122218.png)

æ­¤æ—¶ä»»åŠ¡é˜Ÿåˆ—é‡Œé¢ä»…æœ‰æ•´ä½“ç¨‹åºï¼Œè€Œå¾®ä»»åŠ¡é˜Ÿåˆ—é‡Œé¢ä»€ä¹ˆä¹Ÿæ²¡æœ‰ã€‚æ•´ä½“ç¨‹åºå°†è¿›å…¥æ‰§è¡Œæ ˆä¸­æ‰§è¡Œã€‚
**åˆ›å»º promise å¯¹è±¡ï¼š**åœ¨åˆ›å»º promise å¯¹è±¡æ—¶ï¼Œä¼ å…¥äº†å¯é€‰å‚æ•°å³ï¼š

> (resolve,reject)=>{
> console.log('p');
> }

è€Œ Promise æ„é€ å™¨å°†ä¼šåœ¨è¿”å›æ–°å¯¹è±¡ä¹‹å‰æ‰§è¡Œä¼ å…¥çš„å‡½æ•°å‚æ•°ã€‚æ‰€ä»¥åœ¨æ‰§è¡Œæ ˆä¸­ä¼šæ‰§è¡Œ console.log('p')ï¼Œæ‰“å°å‡º 'p'ã€‚
**æ‰§è¡Œå®šæ—¶å™¨ï¼š**æ‰§è¡Œå®šæ—¶å™¨ï¼Œä¼šåœ¨ä¼ å…¥çš„å»¶è¿Ÿæ—¶é—´ä¹‹åå°†å›è°ƒå‡½æ•°åŠ å…¥é˜Ÿåˆ—ï¼ŒåŠ å…¥ä»€ä¹ˆé˜Ÿåˆ—å‘¢ï¼Œè¿™é‡ŒåŠ å…¥çš„æ˜¯ä»»åŠ¡é˜Ÿåˆ—ï¼Œå› ä¸º settimeoout çš„å›è°ƒå±äºå®ä»»åŠ¡ã€‚ä¹‹åï¼Œå½“å‰æ‰§è¡Œæ ˆä¸ä¸ºç©ºï¼Œä¼šç»§ç»­æ‰§è¡Œã€‚
**æ‰“å° end:**åœ¨æ‰§è¡Œ console.log('end')åï¼Œç°åœ¨æ‰§è¡Œæ ˆä¸ºç©ºäº†ï¼Œæ•´ä½“ç¨‹åºå¼¹å‡ºä»»åŠ¡é˜Ÿåˆ—ã€‚æ­¤æ—¶ä»»åŠ¡é˜Ÿåˆ—æ˜¯**ä¸ä¸ºç©ºçš„**ï¼ˆåŒ…å«å®šæ—¶å™¨çš„å›è°ƒ()=>{console.log('setTime')}ï¼‰

æ­¤æ—¶çš„ JavaScript RunTime çš„æƒ…å†µå¦‚ä¸‹å›¾ï¼š
![2](https://gitee.com/gitme-H/images-bed/raw/master/img/202201122230.png)
è¿™æ—¶çš„ä»»åŠ¡é˜Ÿåˆ—åŒ…æ‹¬å®šæ—¶å™¨çš„å›è°ƒï¼Œè€Œå¾®ä»»åŠ¡é˜Ÿåˆ—ä¾ç„¶ä¸ºç©ºï¼ˆè¿™é“é¢˜å°±æ²¡æ¶‰åŠåˆ°å¾®ä»»åŠ¡ã€‚ã€‚ã€‚ï¼‰ã€‚éšåå®šæ—¶å™¨å›è°ƒå°†è¿›å…¥æ‰§è¡Œæ ˆï¼Œæ‰“å°å‡º setTimeã€‚æ‰€ä»¥æœ€ç»ˆçš„æ‰“å°ç»“æœä¸ºï¼š

> p
> end
> setTime

**è¿™é‡Œå°±æ³¨æ„ promise çš„æ„å»ºå°±è¡Œäº†ï¼Œæ˜¯ç«‹å³æ‰§è¡Œï¼Œæˆ‘é”™çš„æ˜¯åº”ä¸ºå®ƒä¼šè¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚è€Œ Promise è¿›å…¥å¾®ä»»åŠ¡çš„æ˜¯ then çš„å›è°ƒå‡½æ•°ã€‚**

## æ‰©å±•é¢˜ç›®

ä¸Šé¢çš„é¢˜æ²¡æœ‰æ¶‰åŠå¾®ä»»åŠ¡ï¼Œé‚£æˆ‘ä»¬æ”¹æ”¹åŸé¢˜ç›®çœ‹çœ‹ï¼š

```javascript
const p_2 = new Promise((res, rej) => {
  console.log("p_2");
  // å®šæ—¶å™¨1
  setTimeout(() => {
    res("å®šæ—¶å™¨1");
  }, 0);
}).then((v) => console.log(v));
// å®šæ—¶å™¨2
setTimeout(() => {
  console.log("å®šæ—¶å™¨2");
}, 0);
console.log("end");
```

ä¸Šé¢æ–°å¢çš„æ˜¯åœ¨åˆ›å»º Promise å¯¹è±¡æ—¶å¢åŠ äº†ä¸€ä¸ªå®šæ—¶å™¨ï¼Œä»¥åŠå¢åŠ äº†å¯¹ then çš„å›è°ƒã€‚
ä¾æ—§ä»æ•´ä½“ç¨‹åºå¼€å§‹ï¼Œè¿›å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œå½“æ•´ä½“ç¨‹åºæ‰§è¡Œå®Œæ—¶ï¼Œè¿™æ—¶çš„ RunTime æƒ…å†µå¦‚ä¸‹ï¼š
![3](https://gitee.com/gitme-H/images-bed/raw/master/img/202201122252.png)
æ­¤æ—¶è¾“å‡ºä¸ºï¼š

> p_2
> end

æŒ‰ç…§é˜Ÿåˆ—å…ˆè¿›å…ˆå‡ºï¼Œå®šæ—¶å™¨ 1 å…ˆè¿›å…¥é˜Ÿåˆ—ï¼Œæ‰€ä»¥å…¶å…ˆäºå®šæ—¶å™¨ 2 æ‰§è¡Œã€‚æ­¤æ—¶å®šæ—¶å™¨ 1 çš„å›è°ƒè¿›å…¥æ‰§è¡Œæ ˆæ‰§è¡Œï¼Œæ‰§è¡Œ res('å®šæ—¶å™¨ 1')æ”¹å˜ promise çš„çŠ¶æ€ä¸º resolve,å°† then çš„å›è°ƒåŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ­¤æ—¶ RunTime çš„æƒ…å†µå¦‚ä¸‹ï¼š
![4](https://gitee.com/gitme-H/images-bed/raw/master/img/202201122258.png)

å®šæ—¶å™¨ 1 æ‰§è¡Œå®Œæ¯•å¼¹å‡ºä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œåï¼Œæ£€ç´¢å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œè¿™æ—¶å¾®ä»»åŠ¡é˜Ÿåˆ—å­˜åœ¨ä¸€ä¸ª then å›è°ƒï¼Œæ‰€ä»¥å°†å…¶åŠ å…¥æ‰§è¡Œæ ˆã€‚

ç°åœ¨çš„è¾“å‡ºæ˜¯ï¼š

> p_2
> end
> å®šæ—¶å™¨ 1

æœ€ç»ˆï¼Œåªå‰©ä¸‹äº†ä»»åŠ¡é˜Ÿåˆ—çš„å®šæ—¶å™¨ 2 å›è°ƒï¼Œé‡å¤æ—¶é—´å¾ªç¯ï¼Œå°†å®šæ—¶å™¨ 2 çš„å›è°ƒåŠ å…¥æ‰§è¡Œæ ˆå¹¶æ‰§è¡Œã€‚æœ€ç»ˆçš„è¾“å‡ºç»“æœä¸ºï¼š

> p_2
> end
> å®šæ—¶å™¨ 1
> å®šæ—¶å™¨ 2

ä¸Šé¢è¿™é¢˜å°±è¯´æ˜äº†ä¸€ä¸ªä»»åŠ¡å¼¹å‡ºä»»åŠ¡é˜Ÿåˆ—åä¼šæ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå¯æ˜¯åœ¨ä¸Šé¢çš„æ¦‚å¿µä¸€ç« ä¸­è¿˜æåˆ°äº†ä¸€ä¸ªä»»åŠ¡å‡ºé˜Ÿåˆ—åæ˜¯è¦æ‰§è¡Œæ‰€æœ‰çš„å¾®ä»»åŠ¡ï¼Œè€Œä¸Šé¢çš„é‚£ä¸€é¢˜åªæœ‰ä¸€ä¸ªå¾®ä»»åŠ¡çœ‹ä¸å‡ºä»€ä¹ˆè¹Šè··ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†æ”¹ä¸€ä¸‹å§ã€‚

```javascript
const p_2 = new Promise((res, rej) => {
  console.log("p_2");
  // å®šæ—¶å™¨1
  setTimeout(() => {
    res("å®šæ—¶å™¨1");
  }, 0);
}).then((v) => {
  console.log("å¾®ä»»åŠ¡å¼€å§‹");
  for (let i = 0; i < 5; i++) {
    window.queueMicrotask(() => {
      // å‡½æ•°çš„å†…å®¹
      console.log(i);
    });
  }
});
// å®šæ—¶å™¨2
setTimeout(() => {
  console.log("å®šæ—¶å™¨2");
}, 0);
console.log("end");
```

è¿™æ¬¡æˆ‘ä»¬æ›´æ”¹äº† then çš„å›è°ƒï¼Œä½¿ç”¨äº† window.queueMicrotask()æ¥æ·»åŠ å›è°ƒåˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚è¿™æ¬¡æ˜¯æ·»åŠ äº”ä¸ªè¾“å‡ºåˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—é‡Œé¢ã€‚é¡ºç€ä¸Šä¸€é¢˜çš„æ€è·¯ï¼Œæˆ‘ä»¬åªéœ€å°†ä¸Šä¸€é¢˜çš„è¾“å‡º**â€˜å®šæ—¶å™¨ 1â€™**æ›´æ”¹ä¸€ä¸‹å°±è¡Œäº†ã€‚æŒ‰ç…§ä¸€æ¬¡æ‰§è¡Œæ‰æ‰€æœ‰å¾®ä»»åŠ¡çš„ç»“è®ºï¼Œæˆ‘ä»¬å¯ä»¥ä½œå‡ºå¦‚ä¸‹æ›´æ”¹ã€‚

> p_2
> end
> å¾®ä»»åŠ¡å¼€å§‹
> 0
> 1
> 2
> 3
> 4
> å®šæ—¶å™¨ 2

åœ¨ chrome é‡Œé¢è¯•ä¸€ä¸‹å§ï¼šï¼‰
![5](https://gitee.com/gitme-H/images-bed/raw/master/img/202201122327.png)

å¯ä»¥çœ‹è§ï¼Œç»“è®ºæ­£ç¡®ã€‚

**å‚è€ƒï¼š**
[https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide](https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide)
[https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide/In_depth](https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide/In_depth)
